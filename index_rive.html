<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>VantaBuddy</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Kanit:wght@400;700&display=swap');
  html,body{margin:0;padding:0;font-family:"Kanit",sans-serif;background:#fff}
  /* Centered canvas; crisp size/backing set in JS */
  #riveCanvas{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);display:block;z-index:1}

  /* Panel (desktop default: visible) */
  .panel{
    position:fixed;right:16px;top:16px;z-index:3;
    display:flex;flex-direction:column;gap:12px;width:min(480px,92vw);
    background:#fff;border:1px solid #e5e7eb;border-radius:14px;padding:12px;
    box-shadow:0 8px 30px rgba(0,0,0,.07)
  }
  .card{background:#fff;border:1px solid #e5e7eb;border-radius:14px;padding:12px;box-shadow:0 4px 14px rgba(0,0,0,.04)}
  h3{margin:0 0 8px;font-weight:700;font-size:16px}
  .row{display:grid;grid-template-columns:1fr auto;gap:10px;align-items:center;margin-bottom:8px}
  .small{font-size:12px;color:#6b7280}
  .log{font-family:ui-monospace,Menlo,monospace;font-size:12px;max-height:160px;overflow:auto;white-space:pre-wrap;background:#f9fafb;border:1px solid #e5e7eb;border-radius:10px;padding:8px}

  /* Mobile sidebar behavior */
  .overlay{position:fixed;inset:0;background:rgba(0,0,0,.28);z-index:2;display:none}
  .overlay.show{display:block}

  /* Floating toggle button (mobile only) */
  .fab{
    position:fixed;right:16px;bottom:16px;z-index:3;
    padding:10px 14px;border:1px solid #e5e7eb;border-radius:999px;background:#fff;cursor:pointer;
    box-shadow:0 8px 30px rgba(0,0,0,.10);font-family:inherit;font-weight:600
  }

  /* Mobile: slide-in panel */
  @media (max-width: 768px){
    .panel{
      right:0;top:0;height:100vh;width:min(86vw,440px);max-width:440px;
      border-radius:0;border-left:1px solid #e5e7eb;border-top:none;border-bottom:none;border-right:none;
      padding:16px;transform:translateX(100%);transition:transform .25s ease;
    }
    .panel.open{ transform:translateX(0); }
  }
  /* Desktop: hide FAB */
  @media (min-width: 769px){ .fab{ display:none; } }
</style>
</head>
<body>
  <canvas id="riveCanvas"></canvas>

  <!-- Controls panel -->
  <div class="panel" id="controlPanel" aria-label="Controls" role="region">
    <div class="card">
      <h3>Motion (triggers, exclusive)</h3>
      <div class="row"><span>jumping</span><input type="radio" name="motion" id="m-jumping" value="jumping" checked></div>
      <div class="row"><span>floating</span><input type="radio" name="motion" id="m-floating" value="floating"></div>
      <div class="row"><span>floating2</span><input type="radio" name="motion" id="m-floating2" value="floating2"></div>
    </div>

    <div class="card">
      <h3>Direction (triggers, exclusive)</h3>
      <div class="row"><span>turnup</span><input type="radio" name="direction" id="d-turnup" value="turnup"></div>
      <div class="row"><span>turndown</span><input type="radio" name="direction" id="d-turndown" value="turndown"></div>
      <div class="row"><span>turnleft</span><input type="radio" name="direction" id="d-turnleft" value="turnleft"></div>
      <div class="row"><span>turnright</span><input type="radio" name="direction" id="d-turnright" value="turnright"></div>
    </div>

    <div class="card">
      <h3>Debug</h3>
      <div class="small"><strong>Detected inputs:</strong> <span id="detected">(detecting…)</span></div>
      <div class="small" style="margin-top:6px"><strong>Live:</strong> <span id="liveInputs" class="small"></span></div>
      <div class="small" style="margin-top:8px"><strong>State log:</strong></div>
      <div class="log" id="stateLog"></div>
    </div>
  </div>

  <!-- Mobile overlay & toggle -->
  <div class="overlay" id="panelOverlay" aria-hidden="true"></div>
  <button class="fab" id="panelToggle" aria-controls="controlPanel" aria-expanded="false">Controls</button>

  <script src="https://unpkg.com/@rive-app/canvas"></script>
  <script>
  // ====== CONFIG — match your .riv exactly (case-sensitive) ======
  const RIVE_FILE = "vantabuddy.riv";
  const ARTBOARD = "buddy";
  const STATE_MACHINE = "vantabuddy";
  // ===============================================================

  // Sidebar
  const panel = document.getElementById("controlPanel");
  const overlay = document.getElementById("panelOverlay");
  const toggleBtn = document.getElementById("panelToggle");
  function setPanelOpen(open){
    const isMobile = window.matchMedia("(max-width: 768px)").matches;
    if (!isMobile){ // desktop always open look
      panel.classList.remove("open"); overlay.classList.remove("show");
      toggleBtn.setAttribute("aria-expanded","true"); return;
    }
    panel.classList.toggle("open", open);
    overlay.classList.toggle("show", open);
    toggleBtn.setAttribute("aria-expanded", String(open));
  }
  function initPanel(){
    const isMobile = window.matchMedia("(max-width: 768px)").matches;
    setPanelOpen(!isMobile ? true : false);
  }
  initPanel();
  window.addEventListener("resize", initPanel);
  toggleBtn.addEventListener("click", ()=> setPanelOpen(!panel.classList.contains("open")));
  overlay.addEventListener("click", ()=> setPanelOpen(false));
  window.addEventListener("keydown", (e)=>{ if (e.key === "Escape") setPanelOpen(false); });

  // Rive runtime
  const canvas = document.getElementById("riveCanvas");
  const detectedEl = document.getElementById("detected");
  const liveInputsEl = document.getElementById("liveInputs");
  const stateLogEl = document.getElementById("stateLog");

  let riveInstance = null;
  let inputMap = new Map();
  let sampler = null;

  // Centered & crisp canvas
  function layoutCanvas() {
    const dpr = window.devicePixelRatio || 1;
    const sideCss = Math.max(320, Math.min(800, Math.round(Math.min(innerWidth, innerHeight) * 0.7)));
    canvas.style.width = sideCss + "px";
    canvas.style.height = sideCss + "px";
    canvas.width  = Math.round(sideCss * dpr);
    canvas.height = Math.round(sideCss * dpr);
    if (riveInstance) riveInstance.devicePixelRatio = dpr;
  }
  window.addEventListener("resize", layoutCanvas);
  layoutCanvas();

  function rebuildInputMap(){
    inputMap.clear();
    const arr = riveInstance?.stateMachineInputs(STATE_MACHINE) || [];
    for (const i of arr) if (i && i.name) inputMap.set(i.name, i);
  }
  function findInput(name){ rebuildInputMap(); return inputMap.get(name) || null; }
  function typeName(i){
    if (!i) return "Unknown";
    if (rive.StateMachineInputType){
      for (const [k,v] of Object.entries(rive.StateMachineInputType)) if (v===i.type) return k;
    }
    if (typeof i.fire === "function") return "Trigger";
    if (typeof i.value === "boolean")  return "Boolean";
    if (typeof i.value === "number")   return "Number";
    return "Unknown";
  }

  // Fire a trigger (fallback: if boolean, pulse it)
  const raf2 = (fn)=>requestAnimationFrame(()=>requestAnimationFrame(fn));
  function fireInput(name){
    const i = findInput(name);
    if (!i) return false;
    if (typeof i.fire === "function"){ try { i.fire(); } catch(e){} return true; }
    if (typeof i.value === "boolean"){ // fallback if SM still uses booleans
      try { i.value = false; } catch(e){}
      raf2(()=>{ try { i.value = true; } catch(e){} });
      return true;
    }
    return false;
  }

  // Debug helpers
  function listDetected(){
    const arr = riveInstance?.stateMachineInputs(STATE_MACHINE) || [];
    detectedEl.textContent = arr.length ? arr.map(i => `${i.name}(${typeName(i)})`).join(" · ") : "(no inputs found)";
  }
  function startSampler(){
    if (sampler) clearInterval(sampler);
    sampler = setInterval(()=>{
      const arr = riveInstance?.stateMachineInputs(STATE_MACHINE) || [];
      liveInputsEl.innerHTML = arr.map(i=>{
        const v = (typeof i.value === "boolean" || typeof i.value === "number") ? i.value : (typeof i.fire==="function" ? "(trigger)" : "?");
        return `<span class="kv">${i.name}:${v}</span>`;
      }).join(" ");
    }, 250);
  }
  function onStateChange(e){
    if (!e || !e.data) return;
    const now = new Date().toLocaleTimeString();
    const lines = e.data.map(s=>`→ ${s.name}`).join("\n");
    stateLogEl.textContent = (`[${now}] ${lines}\n` + stateLogEl.textContent).slice(0, 4000);
  }

  // Wire radios → fire same-named triggers
  function wireUI(){
    const motionIds = ["m-jumping","m-floating","m-floating2"];
    motionIds.forEach(id=>{
      const el = document.getElementById(id);
      el.addEventListener("change", ()=>{
        if (el.checked) fireInput(el.value);   // value equals the input name
      });
    });
    const dirIds = ["d-turnup","d-turndown","d-turnleft","d-turnright"];
    dirIds.forEach(id=>{
      const el = document.getElementById(id);
      el.addEventListener("change", ()=>{
        if (el.checked) fireInput(el.value);
      });
    });
  }

  // Boot Rive; on load, fire 'jumping'
  function boot(){
    const dpr = window.devicePixelRatio || 1;
    riveInstance = new rive.Rive({
      src: RIVE_FILE,
      canvas,
      artboard: ARTBOARD,
      stateMachines: STATE_MACHINE,
      autoplay: true,
      fit: rive.Fit.Contain,
      alignment: rive.Alignment.Center,
      devicePixelRatio: dpr,
      onStateChange,
      onLoad: () => {
        rebuildInputMap();
        listDetected();
        startSampler();
        wireUI();
        // Start with jumping trigger
        fireInput("jumping");
      },
      onError: (e)=> console.error("[rive] load error:", e)
    });
  }

  boot();
  </script>
</body>
</html>
